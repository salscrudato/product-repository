rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for role-based access control
    function getUserRole() {
      return request.auth.token.role;
    }

    function isAdmin() {
      return getUserRole() == 'admin';
    }

    function isProductManager() {
      return getUserRole() == 'product_manager';
    }

    function isUnderwriter() {
      return getUserRole() == 'underwriter';
    }

    function isViewer() {
      return getUserRole() == 'viewer';
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    // Products collection
    match /products/{productId} {
      // Allow all read/write for development
      allow read, write: if true;

      // Nested coverages
      match /coverages/{coverageId} {
        allow read, write: if true;

        // Limits subcollection
        match /limits/{limitId} {
          allow read, write: if true;
        }

        // Deductibles subcollection
        match /deductibles/{deductibleId} {
          allow read, write: if true;
        }

        // Versions subcollection
        match /versions/{versionId} {
          allow read, write: if true;
        }
      }

      // Packages subcollection
      match /packages/{packageId} {
        allow read, write: if true;
      }

      // Pricing steps subcollection
      match /pricingSteps/{stepId} {
        allow read, write: if true;
      }

      // Data dictionary subcollection
      match /dataDictionary/{fieldId} {
        allow read, write: if true;
      }
    }

    // Forms collection
    match /forms/{formId} {
      allow read, write: if true;
    }

    // Form-Coverage mappings (junction table)
    match /formCoverages/{mappingId} {
      allow read, write: if true;
    }

    // Rules collection
    match /rules/{ruleId} {
      allow read, write: if true;
    }

    // Pricing rules collection
    match /pricingRules/{ruleId} {
      allow read, write: if true;
    }

    // State applicability
    match /stateApplicability/{docId} {
      allow read, write: if true;
    }

    // Versions (global)
    match /versions/{versionId} {
      allow read, write: if true;
    }

    // Catch-all: allow all for development
    match /{document=**} {
      allow read, write: if true;
    }
  }
}