rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // ============================================================================
    // RBAC Helper Functions (mirror Firestore rules)
    // ============================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return request.auth != null && request.auth.token.role != null
        ? request.auth.token.role
        : 'viewer';
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isProductManager() {
      return isAuthenticated() && (getUserRole() == 'product_manager' || isAdmin());
    }

    function isViewer() {
      return isAuthenticated();
    }

    // ============================================================================
    // Form Documents - PDF storage for insurance forms
    // ============================================================================
    match /forms/{formId}/{fileName} {
      // All authenticated users can read forms
      allow read: if isViewer();

      // Only product managers and admins can upload/delete forms
      allow write: if isProductManager();
    }

    // ============================================================================
    // Product Documents - Product-related files
    // ============================================================================
    match /products/{productId}/{allPaths=**} {
      allow read: if isViewer();
      allow write: if isProductManager();
    }

    // ============================================================================
    // Claims Documents - Claims analysis files
    // ============================================================================
    match /claims/{claimId}/{fileName} {
      allow read: if isViewer();
      allow write: if isViewer(); // Underwriters and above can upload claims docs
    }

    // ============================================================================
    // User Uploads - User-specific temporary storage
    // ============================================================================
    match /uploads/{userId}/{fileName} {
      // Users can only access their own uploads
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================================================
    // Public Assets - Logos, static content (read-only for all)
    // ============================================================================
    match /public/{allPaths=**} {
      allow read: if true; // Public assets are readable by anyone
      allow write: if isAdmin(); // Only admins can modify public assets
    }

    // ============================================================================
    // DENY ALL - No catch-all for security
    // Any path not explicitly defined above is inaccessible
    // ============================================================================
  }
}